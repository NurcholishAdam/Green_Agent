name: AgentBeats Build & Publish

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-publish:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Normalize image name (LOWERCASE OWNER)
      # ------------------------------------------------------------
      - name: Set image variables
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_BASE=ghcr.io/${OWNER}/green_agent" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ github.ref_name }}" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Login to GHCR
      # ------------------------------------------------------------
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------------------------
      # Build & push Docker image
      # ------------------------------------------------------------
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.benchmark
          push: true
          tags: |
            ${{ env.IMAGE_BASE }}:${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_BASE }}:latest

      # ------------------------------------------------------------
      # Sync agentbeats.json image field
      # ------------------------------------------------------------
      - name: Sync agentbeats.json
        run: |
          IMAGE="${{ env.IMAGE_BASE }}:latest"
          jq --arg img "$IMAGE" '.image = $img' agentbeats.json > agentbeats.tmp.json
          mv agentbeats.tmp.json agentbeats.json

      # ------------------------------------------------------------
      # Validate agentbeats.json
      # ------------------------------------------------------------
      - name: Validate agentbeats.json
        run: |
          jq . agentbeats.json > /dev/null
          jq -e '.queries | type == "array"' agentbeats.json > /dev/null
          jq -e '.image | type == "string"' agentbeats.json > /dev/null

      # ------------------------------------------------------------
      # Commit sync if changed
      # ------------------------------------------------------------
      - name: Commit updated agentbeats.json
        run: |
          git config user.name "agentbeats-ci"
          git config user.email "agentbeats-ci@users.noreply.github.com"
          git add agentbeats.json
          git diff --cached --quiet || git commit -m "ci: sync agentbeats image"

      - name: Push changes
        run: git push
