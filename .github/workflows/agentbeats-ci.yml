name: AgentBeats CI

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # Sanity checks
      # -------------------------------
      - name: Ensure agentbeats.json exists
        run: |
          if [ ! -f agentbeats.json ]; then
            echo "âŒ agentbeats.json missing at repo root"
            exit 1
          fi

      - name: Validate agentbeats.json
        run: |
          jq . agentbeats.json > /dev/null
          jq -e '.queries | type=="array"' agentbeats.json > /dev/null
          jq -e '.image | ascii_downcase == .' agentbeats.json > /dev/null

      # -------------------------------
      # Docker login (GHCR)
      # -------------------------------
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------
      # HARD RESET Buildx (FIXES unknown blob)
      # -------------------------------
      - name: Reset Docker Buildx
        run: |
          docker buildx rm agentbeats-builder || true
          docker buildx prune -af
          docker system prune -af

      - name: Create fresh Buildx builder
        run: |
          docker buildx create --name agentbeats-builder --use
          docker buildx inspect --bootstrap

      # -------------------------------
      # Build & Push (single arch)
      # -------------------------------
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.benchmark
          platforms: linux/amd64
          push: true
          no-cache: true
          tags: |
            ghcr.io/nurcholishadam/green_agent:main
            ghcr.io/nurcholishadam/green_agent:latest

      # -------------------------------
      # Verify manifest (CRITICAL)
      # -------------------------------
      - name: Verify image manifest
        run: |
          docker manifest inspect ghcr.io/nurcholishadam/green_agent:main
